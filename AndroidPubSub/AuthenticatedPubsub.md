## Using AWS IOT with user sign-in

The sample demonstrates how to use IOT with certificate based authentication. This section demonstrates how to enable signed-in users to use the AWS IoT APIs to securely publish-to and subscribe-from MQTT topics. 

1. First, lets add the sign-in functionality to the app. We provide a drop-in UI that provides a basic set of sign-in screens. You can add the default authentication UI to the app by following the steps [here](https://aws-amplify.github.io/docs/android/authentication).

1. An Amazon Cognito authenticated user needs two policies to access AWS IoT. The first policy is attached to the role of the authenticated pool to authenticate and authorize the Cognito user to communicate with AWS IoT. The second policy is attached to the authenticated Cognito user ID principal for fine-grained permissions. In the [AWS Console](https://console.aws.amazon.com/iam/home?region=us-east-1#/roles), find the role you just created, and attach the following inline IAM Policy to the "authenticated" role of your user pool, to authenticate and authorize the Cognito user to communicate with AWS IoT:

    ```json
    {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Effect": "Allow",
                "Action": [
                    "iot:AttachPrincipalPolicy",
                    "iot:Connect",
                    "iot:Publish",
                    "iot:Subscribe",
                    "iot:Receive"
                ],
                "Resource": [
                    "*"
                ]
            }
        ]
    }
    ```

    **Note**: To keep things simple, the policy created in step 4 above allows access to all the topics under your AWS IoT account. This can be used for getting started and prototypes. In a product, you should scope this policy down to specific topics, specify them explicitly as ARNs in the resource section. Scoping the policy down to specific topics is however not supported currently.

1. In the app, get the credentials provider

    ```java
    credentialsProvider =
                   IdentityManager.getDefaultIdentityManager().getCredentialsProvider();
    ```

1. In the app, after the user logs in using the sign-in UI, get `CognitoIdentity` from `credentialsProvider` and use it to attach the principal policy to the `IotAndroidClient`. Create the IoT policy as specified in step 4 of the [Using the sample](https://github.com/awslabs/aws-sdk-android-samples/tree/master/AndroidPubSub#using-the-sample) section above.

    ```java
    // Setup the logins map
    IdentityManager identityManager = IdentityManager.getDefaultIdentityManager();
    Map<String, String> logins = new HashMap();
    // Get the IdentityProvider, for instance, Facebook, Google, CognitoUserPools
    IdentityProvider currentIdentityProvider = identityManager.getCurrentIdentityProvider();
    // Retrieve the access token from successful sign-in with this provider
    String token = currentIdentityProvider.getToken();
    // Retrieve the key used by Cognito in its login map
    String providerKey = currentIdentityProvider.getCognitoLoginKey();
    // Setup the logins map used to authenticate with Amazon Cognito.
    // The logins map must be set in the credentials provider for it to vend out appropriate AWS Credentials
    logins.put(providerKey, token);
    // Initialize the AWS Cognito credentials provider
    credentialsProvider = new CognitoCachingCredentialsProvider(
        getApplicationContext(), // context
        COGNITO_POOL_ID, // Identity Pool ID
        MY_REGION // Region
    );
    credentialsProvider.setLogins(logins);
    
    AmazonCognitoIdentity cognitoIdentity;
    GetIdRequest getIdReq;
    GetIdResult getIdRes;
    cognitoIdentity = new AmazonCognitoIdentityClient(credentialsProvider);
    getIdReq = new GetIdRequest();
    getIdReq.setLogins(logins);
    getIdReq.setIdentityPoolId(COGNITO_POOL_ID); //Identity pool Id generated by amplify cli
    // cognitoIdentity.getId is a network operation and should not be performed on a main thread
    new Thread(new Runnable() {
        @Override
        public void run() {
        getIdRes = cognitoIdentity.getId(getIdReq);
        AttachPrincipalPolicyRequest attachPolicyReq = new AttachPrincipalPolicyRequest();
        attachPolicyReq.setPolicyName(AWS_IOT_POLICY_NAME);
        attachPolicyReq.setPrincipal(getIdRes.getIdentityId());
        AWSIotClient mIotAndroidClient = new AWSIotClient(credentialsProvider);
        mIotAndroidClient.setRegion(Region.getRegion(MY_REGION));
        mIotAndroidClient.attachPrincipalPolicy(attachPolicyReq);
        }
    }).start();
    ```

1. Create MQTT client and connect

    ```java
    // MQTT Client
    // CUSTOMER_SPECIFIC_ENDPOINT is same as the one used in the sample app above
    mqttManager = new AWSIotMqttManager(clientId, CUSTOMER_SPECIFIC_ENDPOINT); 

    mqttManager.connect(credentialsProvider, new AWSIotMqttClientStatusCallback() {
                        @Override
                        public void onStatusChanged(final AWSIotMqttClientStatus status,
                                                    final Throwable throwable) {
                        }
                    });
    ```
